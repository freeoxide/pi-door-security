# Pi Door Security - Client Agent

A production-ready Raspberry Pi security system for door monitoring and control with cloud connectivity.

---

## ğŸ“– What Is This?

A Rust-based security system that runs on Raspberry Pi to:
- **Monitor** a door using a magnetic reed switch
- **Control** a siren and floodlight via GPIO relays
- **Manage** arming/disarming with multiple input methods
- **Alert** via cloud when intrusions are detected
- **Queue** events offline and replay when connection restored

---

## âœ¨ Key Features

### Security System
- 5-state alarm system: `disarmed â†’ exit_delay â†’ armed â†’ entry_delay â†’ alarm`
- Configurable timers (exit, entry, auto-rearm, siren duration)
- Safe fail-low design (outputs turn off on crash)
- Event audit trail with timestamps

See state machine implementation: [`src/state/machine.rs`](src/state/machine.rs:1)

### Control Methods
- **HTTP REST API** - 9 endpoints for local control
- **WebSocket** - Real-time events and commands  
- **Cloud** - Secure TLS 1.3 connection (no app-layer auth for v1)
- **BLE** - Bluetooth pairing for mobile (stub)
- **RF 433MHz** - Remote control support (stub)

API handlers: [`src/api/handlers/`](src/api/handlers/)  
WebSocket server: [`src/api/handlers/websocket.rs`](src/api/handlers/websocket.rs:1)  
Cloud client: [`src/cloud/client.rs`](src/cloud/client.rs:1)

### Production Ready
- âœ… Zero warnings - Clean build
- âœ… 68 passing tests - 100% pass rate
- âœ… Systemd integration - Watchdog, auto-restart
- âœ… Graceful shutdown - SIGTERM/SIGINT handling
- âœ… Minimal attack surface - no local secret storage
- âœ… Network redundancy - eth0 â†’ wlan0 failover

---

## ğŸ—ï¸ Architecture

### Component Structure
```
HTTP/WS Server â†â†’ State Machine â†â†’ GPIO Controller
      â†“                â†“                   â†“
  Event Bus      Timers & Logic      Actuators
      â†“                                    
Event Queue â†’ Cloud WebSocket (TLS 1.3)
```

### Key Modules

| Module | Description | File |
|--------|-------------|------|
| **State Machine** | Alarm state logic & transitions | [`src/state/machine.rs`](src/state/machine.rs:1) |
| **GPIO** | Hardware abstraction (mock + real) | [`src/gpio/`](src/gpio/) |
| **API** | HTTP/WebSocket server (Axum) | [`src/api/`](src/api/) |
| **Events** | Event bus and persistent queue | [`src/events/`](src/events/) |
| **Cloud** | WebSocket client with TLS | [`src/cloud/`](src/cloud/) |
| **Config** | Defaults + optional TOML configuration | [`src/config/`](src/config/) |
| **Security** | Privilege dropping | [`src/security/`](src/security/) |
| **Network** | Interface failover manager | [`src/network/mod.rs`](src/network/mod.rs:1) |

---

## ğŸš€ Quick Start

### Development (Any Platform)
```bash
cd client_server
cargo run -- --api-key your-master-issued-key
```

This starts the server with **mock GPIO** (safe for development without Pi hardware). For local testing use a placeholder key; production deployments receive a UUID from the master server.

**Test it:**
```bash
curl http://localhost:8080/v1/health
curl http://localhost:8080/v1/status
```

### Run Tests
```bash
cargo test
```

Expected: 68/68 tests passing

---

## ğŸ“¦ Deployment to Raspberry Pi

### 1. Build for Production
```bash
cargo build --release --features real-gpio
```

The `real-gpio` feature enables actual GPIO hardware control via rppal.

### 2. Install Binary
```bash
sudo cp target/release/pi-door-client /usr/local/bin/
```

### 3. Setup Configuration
```bash
sudo mkdir -p /etc/pi-door-client
sudo cp examples/config.toml /etc/pi-door-client/config.toml
```

Edit configuration: [`examples/config.toml`](examples/config.toml:1)

### 4. Provide Master API Key
Edit the systemd unit (or launch script) to include the UUID generated by the master server:

```ini
ExecStart=/usr/local/bin/pi-door-client \
    --api-key 123e4567-e89b-12d3-a456-426614174000
```

Replace the example UUID with the real key issued during provisioning.

### 5. Install Systemd Service
```bash
sudo cp pi-door-client.service /etc/systemd/system/
sudo systemctl daemon-reload
```

Service unit file: [`pi-door-client.service`](pi-door-client.service:1)

### 6. Create Service User
```bash
sudo useradd -r -s /bin/false pi-client
sudo mkdir -p /var/lib/pi-door-client
sudo chown pi-client:pi-client /var/lib/pi-door-client
```

Privilege dropping: [`src/security/privileges.rs`](src/security/privileges.rs:1)

### 7. Start Service
```bash
sudo systemctl enable --now pi-door-client
```

### 8. Verify
```bash
systemctl status pi-door-client
journalctl -u pi-door-client -f
curl http://localhost:8080/v1/health
```

---

## ğŸ”Œ Hardware Wiring

Default GPIO pin mapping (configurable in config):

| Component | GPIO Pin | BCM Pin | Direction | Notes |
|-----------|----------|---------|-----------|-------|
| Reed Switch | Pin 11 | BCM 17 | Input | Pull-up enabled, active low |
| Siren Relay | Pin 13 | BCM 27 | Output | Active high, fail-safe low |
| Floodlight Relay | Pin 15 | BCM 22 | Output | Active high, fail-safe low |
| RF 433MHz RX | Pin 16 | BCM 23 | Input | Data pin from receiver |

GPIO configuration: [`src/config/schema.rs`](src/config/schema.rs:64-74)  
Real GPIO implementation: [`src/gpio/rppal.rs`](src/gpio/rppal.rs:1)  
Mock GPIO (dev): [`src/gpio/mock.rs`](src/gpio/mock.rs:1)

---

## ğŸŒ API Endpoints

### Health & Status
- `GET /v1/health` - Health check with uptime
- `GET /v1/status` - Complete system status

Handler: [`src/api/handlers/mod.rs`](src/api/handlers/mod.rs:24-35)  
Status handler: [`src/api/handlers/status.rs`](src/api/handlers/status.rs:1)

### Arming
- `POST /v1/arm` - Arm the system
- `POST /v1/disarm` - Disarm the system

Handler: [`src/api/handlers/arm_disarm.rs`](src/api/handlers/arm_disarm.rs:1)

### Actuators
- `POST /v1/siren` - Control siren manually
- `POST /v1/floodlight` - Control floodlight manually

Handler: [`src/api/handlers/actuators.rs`](src/api/handlers/actuators.rs:1)

### Configuration
- `GET /v1/config` - Get config snapshot
- `PUT /v1/config` - Update configuration

Handler: [`src/api/handlers/config.rs`](src/api/handlers/config.rs:1)

### BLE
- `POST /v1/ble/pairing` - Enable BLE pairing window

Handler: [`src/api/handlers/ble.rs`](src/api/handlers/ble.rs:1)

### WebSocket
- `GET /v1/ws` - WebSocket upgrade for real-time events

Handler: [`src/api/handlers/websocket.rs`](src/api/handlers/websocket.rs:1)

---

## ğŸ“¡ WebSocket Protocol

### Client â†’ Server (Commands)
```json
{"type":"cmd","name":"arm","exit_delay_s":30,"id":"cmd1"}
{"type":"cmd","name":"disarm","id":"cmd2"}
{"type":"cmd","name":"siren","on":true,"duration_s":60,"id":"cmd3"}
```

### Server â†’ Client (Events)
```json
{"type":"event","name":"state","value":"armed","ts":"2025-01-08T12:00:00Z"}
{"type":"event","name":"door","value":"open","ts":"2025-01-08T12:00:01Z"}
{"type":"event","name":"alarm_triggered","ts":"2025-01-08T12:00:30Z"}
```

### Server â†’ Client (Acknowledgments)
```json
{"type":"ack","id":"cmd1","ok":true}
{"type":"ack","id":"cmd3","ok":false,"error":"invalid_duration"}
```

WebSocket implementation: [`src/api/handlers/websocket.rs`](src/api/handlers/websocket.rs:35-229)

---

## â˜ï¸ Cloud Integration

### Connection
- **Protocol**: WebSocket over TLS 1.3
- **Auth**: None for v1 (trust established out-of-band)
- **Heartbeat**: Client sends ping every 20 seconds
- **Reconnection**: Exponential backoff (1s â†’ 60s with jitter)

Cloud client: [`src/cloud/client.rs`](src/cloud/client.rs:1)  
Reconnection logic: [`src/cloud/reconnect.rs`](src/cloud/reconnect.rs:1)

### Offline Queue
- **Storage**: Sled database at `/var/lib/pi-door-client/events.db`
- **Capacity**: 10,000 events or 7 days (whichever first)
- **Behavior**: Queue events while offline, replay on reconnect
- **Order**: FIFO (oldest first)

Queue implementation: [`src/events/queue.rs`](src/events/queue.rs:1)  
Queue manager: [`src/cloud/queue_manager.rs`](src/cloud/queue_manager.rs:1)

---

## âš™ï¸ Configuration

Configuration file: [`examples/config.toml`](examples/config.toml:1)

### Layers (in order of precedence)
1. Config file (`/etc/pi-door-client/config.toml`)
2. Built-in defaults

Configuration schema: [`src/config/schema.rs`](src/config/schema.rs:1)  
Validation: [`src/config/validation.rs`](src/config/validation.rs:1)

### Key Settings

**System**
- `client_id` - Unique identifier for this Pi
- `data_dir` - Data storage directory
- `log_level` - Logging verbosity (trace/debug/info/warn/error)

**Network**
- `prefer` - Interface priority list (e.g., `["eth0", "wlan0"]`)
- `enable_lte` - Enable LTE modem (default: false)

**HTTP**
- `listen_addr` - Server bind address (default: `0.0.0.0:8080`)

**GPIO**
- `reed_in` - Reed switch input pin (BCM numbering)
- `reed_active_low` - Invert reed logic (true = closed when low)
- `siren_out` - Siren relay output pin
- `floodlight_out` - Floodlight relay output pin
- `radio433_rx_in` - RF receiver data pin

**Timers**
- `exit_delay_s` - Delay after arming before fully armed (default: 30)
- `entry_delay_s` - Delay after door open before alarm (default: 30)
- `auto_rearm_s` - Auto-rearm after disarm (0 = disabled)
- `siren_max_s` - Maximum siren duration (default: 120)

**Cloud**
- `url` - Cloud WebSocket URL (e.g., `wss://api.example.com/client`)
- `heartbeat_s` - Heartbeat interval (default: 20)
- `queue_max_events` - Max offline events (default: 10000)
- `queue_max_age_days` - Max event age (default: 7)

---

## ğŸ” Security

### Credential Handling
- Master server issues the API key during provisioning and passes it via `--api-key <uuid>`.
- The client never persists credentials to disk or environment variables.
- Logging avoids printing sensitive values.

### Cloud Trust
- TLS 1.3 provides confidentiality and server authentication.
- No additional application-layer authentication for v1; rely on deployment trust boundaries.

### Privilege Dropping
The service starts as root to bind ports and access GPIO, then drops to `pi-client` user.

Implementation: [`src/security/privileges.rs`](src/security/privileges.rs:1)

---

## ğŸ“Š State Machine

### States
1. **Disarmed** - System inactive, door can open freely
2. **Exit Delay** - Countdown after arming before fully armed
3. **Armed** - System active, monitors door sensor
4. **Entry Delay** - Countdown after door open to allow disarm
5. **Alarm** - Siren and floodlight active, notifying cloud

### Transitions
See state diagram in specification: [`docs/refined_specs.md`](docs/refined_specs.md:116-128)

Implementation: [`src/state/machine.rs`](src/state/machine.rs:1)  
Transition logic: [`src/state/transitions.rs`](src/state/transitions.rs:1)

### Timers
All timers are managed by: [`src/timers/mod.rs`](src/timers/mod.rs:1)

---

## ğŸ§ª Testing

### Run All Tests
```bash
cargo test
```

### Test Breakdown
- **Unit tests**: 58 tests across all modules
- **API integration**: 7 tests for HTTP endpoints
- **State machine**: 3 tests for alarm workflows
- **Total**: 68 tests (100% pass rate)

Test files:
- [`tests/api_integration.rs`](tests/api_integration.rs:1)
- [`tests/state_machine_integration.rs`](tests/state_machine_integration.rs:1)

### Hardware Tests
Tests requiring Raspberry Pi GPIO are marked with `#[ignore]` and can be run on Pi:
```bash
cargo test -- --ignored
```

Hardware tests: [`src/gpio/rppal.rs`](src/gpio/rppal.rs:195-227)

---

## ğŸ”§ Development

### Project Structure
```
client_server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs              # Entry point
â”‚   â”œâ”€â”€ lib.rs               # Library exports
â”‚   â”œâ”€â”€ api/                 # HTTP/WebSocket server
â”‚   â”œâ”€â”€ state/               # State machine
â”‚   â”œâ”€â”€ gpio/                # GPIO abstraction
â”‚   â”œâ”€â”€ events/              # Event system
â”‚   â”œâ”€â”€ cloud/               # Cloud client
â”‚   â”œâ”€â”€ config/              # Configuration
â”‚   â”œâ”€â”€ security/            # Secrets & privileges
â”‚   â”œâ”€â”€ network/             # Network redundancy
â”‚   â”œâ”€â”€ timers/              # Timer management
â”‚   â”œâ”€â”€ actuators/           # Siren/floodlight control
â”‚   â”œâ”€â”€ health/              # Systemd watchdog
â”‚   â”œâ”€â”€ observability/       # Logging
â”‚   â”œâ”€â”€ ble/                 # BLE GATT (stub)
â”‚   â””â”€â”€ rf433/               # RF receiver (stub)
â”œâ”€â”€ tests/                   # Integration tests
â”œâ”€â”€ examples/                # Example configuration
â”œâ”€â”€ docs/                    # Documentation
â”œâ”€â”€ Cargo.toml               # Dependencies
â””â”€â”€ pi-door-client.service   # Systemd unit
```

### Adding Features
1. **New API endpoint**: Add handler in [`src/api/handlers/`](src/api/handlers/)
2. **New event type**: Update [`src/events/types.rs`](src/events/types.rs:1)
3. **New state**: Modify [`src/state/machine.rs`](src/state/machine.rs:1)
4. **New config**: Update [`src/config/schema.rs`](src/config/schema.rs:1)

Main entry point: [`src/main.rs`](src/main.rs:1)

---

## ğŸ“š Documentation

### Specifications
- **Refined specs**: [`docs/refined_specs.md`](docs/refined_specs.md:1) - Complete technical specification
- **Implementation plan**: [`docs/implementation_plan.md`](docs/implementation_plan.md:1) - Development roadmap
- **Implementation status**: [`docs/implementation_status.md`](docs/implementation_status.md:1) - Current progress

### Code Documentation
Generate and view documentation:
```bash
cargo doc --open
```

---

## ğŸ› Troubleshooting

### Service Won't Start
```bash
# Check status
systemctl status pi-door-client

# View logs
journalctl -u pi-door-client -n 50

# Quick CLI help
pi-door-client --help
```

### GPIO Not Working
1. Verify running on Raspberry Pi
2. Check feature flag: `cargo build --release --features real-gpio`
3. Verify user has GPIO permissions
4. Check pin configuration in config file

GPIO implementation: [`src/gpio/rppal.rs`](src/gpio/rppal.rs:1)

### Cloud Connection Issues
1. Verify the `--api-key` value matches the key issued by the master server
2. Confirm TLS certificates are trusted on the Pi
3. Check cloud URL in config
4. View reconnection logs in journald

Cloud client: [`src/cloud/client.rs`](src/cloud/client.rs:1)  
Reconnection: [`src/cloud/reconnect.rs`](src/cloud/reconnect.rs:1)

### Events Not Queuing
1. Check data directory permissions: `/var/lib/pi-door-client`
2. Verify disk space available
3. Check queue configuration limits

Queue implementation: [`src/events/queue.rs`](src/events/queue.rs:1)

---

## ğŸ“ License

See root project LICENSE file.

---

## ğŸ¤ Contributing

1. Write tests for new features
2. Ensure `cargo test` passes (68/68 tests)
3. Ensure `cargo clippy` has no warnings
4. Update documentation

---

## ğŸ“ Support

For issues or questions, refer to:
- Technical specification: [`docs/refined_specs.md`](docs/refined_specs.md:1)
- Implementation status: [`docs/implementation_status.md`](docs/implementation_status.md:1)
- API documentation: `cargo doc --open`
